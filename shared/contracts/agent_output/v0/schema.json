{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://nuance.app/schemas/agent-output/v0.1.0.json",
  "title": "AgentOutputContract",
  "description": "Standardized output contract for all agent turns, regardless of intent type",
  "type": "object",
  "required": ["contract_version", "request_id", "intent", "timestamp", "output"],
  "properties": {
    "contract_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of this contract (e.g., '0.1.0')"
    },
    "request_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this request/turn"
    },
    "trace_id": {
      "type": "string",
      "description": "Optional trace ID for distributed tracing"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of when this response was generated"
    },
    "intent": {
      "$ref": "#/$defs/IntentClassification"
    },
    "output": {
      "$ref": "#/$defs/AgentOutput"
    },
    "provenance": {
      "$ref": "#/$defs/Provenance"
    }
  },
  "$defs": {
    "IntentType": {
      "type": "string",
      "enum": ["capture", "coaching", "command", "clarify"],
      "description": "The classified intent type"
    },
    "IntentClassification": {
      "type": "object",
      "required": ["type", "confidence"],
      "properties": {
        "type": {
          "$ref": "#/$defs/IntentType"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence score for intent classification"
        },
        "reasoning": {
          "type": "string",
          "description": "Optional reasoning for classification"
        }
      }
    },
    "CaptureType": {
      "type": "string",
      "enum": ["goal", "plan", "habit", "task", "reflection", "blocker", "metric"],
      "description": "Type of captured item"
    },
    "TaxonomyLayer": {
      "type": "object",
      "description": "7-layer taxonomy classification for a capture",
      "properties": {
        "intent_layer": {
          "type": "string",
          "enum": ["capture", "clarify", "execute", "reflect", "unknown"],
          "description": "What the user intends to do"
        },
        "survival_function": {
          "type": "string",
          "enum": ["maintenance", "growth", "protection", "connection", "unknown"],
          "description": "Core need being addressed"
        },
        "cognitive_load": {
          "type": "string",
          "enum": ["routine", "high_friction", "unknown"],
          "description": "Mental effort required"
        },
        "time_horizon": {
          "type": "string",
          "enum": ["immediate", "today", "this_week", "this_month", "long_term", "unknown"],
          "description": "When this needs attention"
        },
        "agency_level": {
          "type": "string",
          "enum": ["autonomous", "delegated", "blocked", "unknown"],
          "description": "User's control over this item"
        },
        "psych_source": {
          "type": "string",
          "enum": ["intrinsic", "extrinsic", "avoidance", "unknown"],
          "description": "Psychological motivation source"
        },
        "system_role": {
          "type": "string",
          "enum": ["capture", "scaffold", "track", "remind", "coach", "unknown"],
          "description": "What role the system should play"
        }
      }
    },
    "MagnitudeInference": {
      "type": "object",
      "description": "Inferred scope and complexity of a capture",
      "properties": {
        "scope": {
          "type": "string",
          "enum": ["atomic", "composite", "project"],
          "description": "Size/scope of the item"
        },
        "complexity": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Complexity score 1-5"
        },
        "dependencies": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of inferred dependencies"
        },
        "uncertainty": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Uncertainty about scope (0=certain, 1=very uncertain)"
        }
      }
    },
    "StateInference": {
      "type": "object",
      "description": "Inferred current state of a capture",
      "properties": {
        "stage": {
          "type": "string",
          "enum": ["not_started", "in_progress", "blocked", "waiting", "done", "unknown"],
          "description": "Current lifecycle stage"
        },
        "bottleneck": {
          "type": "string",
          "description": "What's blocking progress, if any"
        },
        "energy_required": {
          "type": "string",
          "enum": ["low", "medium", "high", "unknown"],
          "description": "Energy/effort required"
        }
      }
    },
    "Capture": {
      "type": "object",
      "required": ["id", "type", "title", "raw_segment", "confidence"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Temporary ID for this capture within the turn"
        },
        "type": {
          "$ref": "#/$defs/CaptureType"
        },
        "title": {
          "type": "string",
          "description": "Normalized title in imperative form"
        },
        "raw_segment": {
          "type": "string",
          "description": "Original text segment this was extracted from"
        },
        "estimated_minutes": {
          "type": "integer",
          "minimum": 0,
          "description": "Estimated time in minutes"
        },
        "avoidance_weight": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Emotional resistance score 1-5"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Extraction confidence"
        },
        "ambiguities": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Potential clarifications needed"
        },
        "labels": {
          "$ref": "#/$defs/TaxonomyLayer"
        },
        "magnitude": {
          "$ref": "#/$defs/MagnitudeInference"
        },
        "state": {
          "$ref": "#/$defs/StateInference"
        },
        "needs_breakdown": {
          "type": "boolean",
          "description": "Whether this capture should be broken down"
        }
      }
    },
    "AtomicTask": {
      "type": "object",
      "required": ["id", "verb", "object"],
      "description": "A micro-step derived from a capture",
      "properties": {
        "id": {
          "type": "string",
          "description": "Temporary ID for this task"
        },
        "parent_capture_id": {
          "type": "string",
          "description": "ID of the capture this task belongs to"
        },
        "verb": {
          "type": "string",
          "description": "Action verb (e.g., 'Open', 'Write', 'Call')"
        },
        "object": {
          "type": "string",
          "description": "Object of the action (e.g., 'laptop', 'email', 'mom')"
        },
        "full_description": {
          "type": "string",
          "description": "Full task description"
        },
        "definition_of_done": {
          "type": "string",
          "description": "Clear completion criteria"
        },
        "estimated_minutes": {
          "type": "integer",
          "minimum": 1,
          "maximum": 30,
          "description": "Time estimate (micro-steps are 1-30 min)"
        },
        "energy_level": {
          "type": "string",
          "enum": ["low", "medium", "high"],
          "description": "Energy required"
        },
        "prerequisites": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Task IDs that must complete first"
        },
        "is_first_action": {
          "type": "boolean",
          "description": "Whether this is the recommended first step"
        },
        "is_physical": {
          "type": "boolean",
          "description": "Whether this involves physical movement"
        }
      }
    },
    "StateUpdate": {
      "type": "object",
      "required": ["entity_type", "operation"],
      "description": "A database entity change from this turn",
      "properties": {
        "entity_type": {
          "type": "string",
          "enum": ["action", "conversation", "message", "profile"],
          "description": "Type of entity affected"
        },
        "entity_id": {
          "type": "string",
          "format": "uuid",
          "description": "ID of the entity (null for creates before persistence)"
        },
        "temp_id": {
          "type": "string",
          "description": "Temporary ID referencing a capture/task in this turn"
        },
        "operation": {
          "type": "string",
          "enum": ["created", "updated", "deleted"],
          "description": "Type of change"
        },
        "changes": {
          "type": "object",
          "additionalProperties": true,
          "description": "Field changes (for updates)"
        }
      }
    },
    "ClarificationQuestion": {
      "type": "object",
      "required": ["id", "question", "target_capture_id"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Question ID"
        },
        "question": {
          "type": "string",
          "description": "The clarification question"
        },
        "target_capture_id": {
          "type": "string",
          "description": "Which capture this question is about"
        },
        "question_type": {
          "type": "string",
          "enum": ["scope", "timeline", "priority", "blocker", "other"],
          "description": "Category of clarification"
        },
        "suggested_answers": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Optional suggested responses"
        }
      }
    },
    "UIBlock": {
      "type": "object",
      "required": ["type"],
      "description": "Structured rendering hint for the UI",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["capture_list", "breakdown_steps", "coaching_message", "insight_card", "question_prompt", "command_result"],
          "description": "Type of UI block"
        },
        "data": {
          "type": "object",
          "additionalProperties": true,
          "description": "Block-specific data"
        },
        "priority": {
          "type": "integer",
          "minimum": 0,
          "description": "Display priority (lower = higher priority)"
        }
      }
    },
    "PsychologicalInsight": {
      "type": "object",
      "properties": {
        "pattern_name": {
          "type": "string",
          "description": "Name of the detected pattern"
        },
        "description": {
          "type": "string",
          "description": "What the AI noticed"
        },
        "suggested_strategy": {
          "type": "string",
          "description": "Recommended approach"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    },
    "AgentOutput": {
      "type": "object",
      "description": "The core output payload",
      "properties": {
        "raw_input": {
          "type": "string",
          "description": "Original user input"
        },
        "captures": {
          "type": "array",
          "items": { "$ref": "#/$defs/Capture" },
          "description": "Extracted captures (goals/plans/habits/tasks/etc)"
        },
        "atomic_tasks": {
          "type": "array",
          "items": { "$ref": "#/$defs/AtomicTask" },
          "description": "Breakdown micro-steps"
        },
        "state_updates": {
          "type": "array",
          "items": { "$ref": "#/$defs/StateUpdate" },
          "description": "Entity changes from this turn"
        },
        "questions": {
          "type": "array",
          "items": { "$ref": "#/$defs/ClarificationQuestion" },
          "description": "Clarification questions for the user"
        },
        "insights": {
          "type": "array",
          "items": { "$ref": "#/$defs/PsychologicalInsight" },
          "description": "Detected patterns"
        },
        "coaching_message": {
          "type": "string",
          "description": "Coaching/support response (for coaching intent)"
        },
        "command_result": {
          "type": "object",
          "properties": {
            "command": { "type": "string" },
            "message": { "type": "string" },
            "data": { "type": "object", "additionalProperties": true }
          },
          "description": "Command execution result"
        },
        "user_facing_summary": {
          "type": "string",
          "description": "Human-readable summary of this turn"
        },
        "ui_blocks": {
          "type": "array",
          "items": { "$ref": "#/$defs/UIBlock" },
          "description": "Structured UI rendering hints"
        },
        "overall_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Overall confidence in this output"
        },
        "cognitive_load": {
          "type": "string",
          "enum": ["routine", "high_friction"],
          "description": "Appraised cognitive load of input"
        },
        "needs_scaffolding": {
          "type": "boolean",
          "description": "Whether AI should probe deeper"
        },
        "scaffolding_question": {
          "type": "string",
          "description": "Probe question if needs_scaffolding is true"
        }
      }
    },
    "Provenance": {
      "type": "object",
      "description": "Metadata about how this output was generated",
      "properties": {
        "model_id": {
          "type": "string",
          "description": "LLM model used"
        },
        "prompt_versions": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Map of prompt name to version used"
        },
        "processing_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Total processing time in milliseconds"
        },
        "token_usage": {
          "type": "object",
          "properties": {
            "input_tokens": { "type": "integer", "minimum": 0 },
            "output_tokens": { "type": "integer", "minimum": 0 }
          }
        }
      }
    }
  }
}
